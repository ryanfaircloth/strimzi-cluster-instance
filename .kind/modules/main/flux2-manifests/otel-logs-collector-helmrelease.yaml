apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: otel-logs-collector
  namespace: opentelemetry-operator-system
spec:
  releaseName: otel-logs-collector
  chart:
    spec:
      chart: raw
      version: "2.0.2"
      sourceRef:
        kind: HelmRepository
        name: bedag
        namespace: flux-system
  dependsOn:
    - name: opentelemetry-operator
      namespace: opentelemetry-operator-system
  interval: 5m
  values:
    resources:
      - apiVersion: opentelemetry.io/v1alpha1
        kind: OpenTelemetryCollector
        metadata:
          name: agent
          namespace: opentelemetry-operator-system
        spec:
          mode: daemonset
          serviceAccount: agent
          env:
            - name: KUBE_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
          volumes:
            - name: varlogpods
              hostPath:
                path: /var/log/pods
            - name: varlibdockercontainers
              hostPath:
                path: /var/lib/docker/containers
            - name: varlogcontainers
              hostPath:
                path: /var/log/containers
            - name: otel-logs-storage
              emptyDir: {}
          volumeMounts:
            - name: varlogpods
              mountPath: /var/log/pods
              readOnly: true
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
            - name: varlogcontainers
              mountPath: /var/log/containers
              readOnly: true
            - name: otel-logs-storage
              mountPath: /otel-logs-storage
          config: |
            receivers:
              # OTLP receiver for application telemetry
              otlp:
                protocols:
                  grpc:
                    endpoint: 0.0.0.0:4317
                  http:
                    endpoint: 0.0.0.0:4318
              
              # File log collection from Kubernetes pods
              filelog:
                include:
                  - /var/log/pods/*/*/*.log
                exclude:
                  # Exclude logs from the logging system itself to prevent loops
                  - /var/log/pods/opentelemetry-operator-system_*/*/*.log
                  - /var/log/pods/flux-system_*/*/*.log
                start_at: end
                include_file_path: true
                include_file_name: false
                operators:
                  # Handle multiline logs - merge lines starting with whitespace
                  - type: recombine
                    id: multiline-merger
                    combine_field: body
                    is_first_entry: 'body matches "^\\S"'
                  # Parse container logs using the standard container operator
                  - type: container
                    id: container-parser
                  # Parse JSON structured logs
                  - type: json_parser
                    id: json-parser
                    parse_from: body
                    parse_to: attributes
                    on_error: send
                  # Parse log level to OpenTelemetry severity
                  - type: severity_parser
                    id: severity-parser
                    parse_from: attributes.level
                    on_error: send
                  # Parse log_level to OpenTelemetry severity if level wasn't found
                  - type: severity_parser
                    id: severity-parser-alt
                    parse_from: attributes.log_level
                    on_error: send
                  # Remove original level fields after parsing
                  - type: remove
                    id: remove-level
                    field: attributes.level
                    if: attributes.level != nil
                  - type: remove
                    id: remove-log-level
                    field: attributes.log_level
                    if: attributes.log_level != nil
                  # Map legacy field names to semantic conventions
                  - type: move
                    id: map-legacy-app-to-service-name
                    from: attributes.legacy.app
                    to: attributes.service.name
                    if: 'attributes.legacy.app != nil and attributes.service.name == nil'
                  - type: move
                    id: map-legacy-version-to-service-version
                    from: attributes.legacy.version
                    to: attributes.service.version
                    if: 'attributes.legacy.version != nil and attributes.service.version == nil'
                  # Clean up legacy fields after mapping
                  - type: remove
                    id: remove-legacy-app
                    field: attributes.legacy.app
                    if: attributes.legacy.app != nil
                  - type: remove
                    id: remove-legacy-version
                    field: attributes.legacy.version
                    if: attributes.legacy.version != nil
                  # Parse W3C Trace Context with regex (lowercase)
                  - type: regex_parser
                    id: parse-w3c-trace-context-lower
                    if: attributes.traceparent != nil
                    parse_from: attributes.traceparent
                    regex: '^(?P<version>[0-9a-f]{2})-(?P<trace_id>[0-9a-f]{32})-(?P<span_id>[0-9a-f]{16})-(?P<trace_flags>[0-9a-f]{2})$'
                    parse_to: attributes.w3c_trace
                  # Parse W3C Trace Context with regex (uppercase)  
                  - type: regex_parser
                    id: parse-w3c-trace-context-upper
                    if: attributes.Traceparent != nil
                    parse_from: attributes.Traceparent
                    regex: '^(?P<version>[0-9a-f]{2})-(?P<trace_id>[0-9a-f]{32})-(?P<span_id>[0-9a-f]{16})-(?P<trace_flags>[0-9a-f]{2})$'
                    parse_to: attributes.w3c_trace
                  # Move parsed trace_id and span_id to resource for proper trace correlation
                  - type: move
                    id: set-trace-id-from-w3c
                    from: attributes.w3c_trace.trace_id
                    to: resource.trace_id
                    if: attributes.w3c_trace.trace_id != nil
                  - type: move
                    id: set-span-id-from-w3c
                    from: attributes.w3c_trace.span_id
                    to: resource.span_id
                    if: attributes.w3c_trace.span_id != nil
                  # Clean up temporary w3c_trace object
                  - type: remove
                    id: remove-w3c-trace-temp
                    field: attributes.w3c_trace
                    if: attributes.w3c_trace != nil
                  # Set top-level trace_id and span_id from resource for proper correlation
                  - type: trace_parser
                    id: set-trace-correlation
                    if: resource.trace_id != nil
                    trace_id:
                      parse_from: resource.trace_id
                    span_id:
                      parse_from: resource.span_id
                  # Remove original traceparent field after parsing
                  - type: remove
                    id: remove-traceparent
                    field: attributes.traceparent
                    if: attributes.traceparent != nil
                  - type: remove
                    id: remove-Traceparent
                    field: attributes.Traceparent
                    if: attributes.Traceparent != nil
                  # Remove trace fields from resource since they should only be at top level
                  - type: remove
                    id: remove-resource-trace-id
                    field: resource.trace_id
                    if: resource.trace_id != nil
                  - type: remove
                    id: remove-resource-span-id
                    field: resource.span_id
                    if: resource.span_id != nil
                  - type: remove
                    id: remove-version
                    field: attributes.version
                    if: 'attributes.version != nil and attributes.version matches "^[0-9a-f]{2}$"'
                  # Extract main message from msg field if present
                  - type: move
                    id: extract-msg-field
                    from: attributes.msg
                    to: body
                    if: attributes.msg != nil
                  # Extract main message from message field if present
                  - type: move
                    id: extract-message-field
                    from: attributes.message
                    to: body
                    if: attributes.message != nil
                storage: file_storage

            processors:
              batch:
                timeout: 1s
                send_batch_size: 1024
              
              k8sattributes:
                auth_type: "serviceAccount"
                passthrough: false
                filter:
                  node_from_env_var: KUBE_NODE_NAME
                extract:
                  metadata:
                    - k8s.pod.name
                    - k8s.pod.uid
                    - k8s.deployment.name
                    - k8s.namespace.name
                    - k8s.node.name
                    - k8s.pod.start_time
                  labels:
                    - tag_name: service.name
                      key: app.kubernetes.io/name
                      from: pod
                    - tag_name: service.version
                      key: app.kubernetes.io/version
                      from: pod
                    - tag_name: service.component
                      key: app.kubernetes.io/component
                      from: pod
                    - tag_name: service.instance.id
                      key: app.kubernetes.io/instance
                      from: pod
                    # Legacy label mappings
                    - tag_name: legacy.app
                      key: app
                      from: pod
                    - tag_name: legacy.version
                      key: version
                      from: pod
                  annotations:
                    - tag_name: deployment_config
                      key: deployment.kubernetes.io/config-hash
                      from: pod
                pod_association:
                  - sources:
                      - from: resource_attribute
                        name: k8s.pod.uid
                  - sources:
                      - from: resource_attribute
                        name: k8s.pod.name
                      - from: resource_attribute
                        name: k8s.namespace.name

              resource:
                attributes:
                  # Set fallback service name for logs without k8s labels
                  - key: fallback.service.name
                    value: kubernetes-logs
                    action: upsert
                  - key: deployment.environment
                    value: dev
                    action: upsert

            extensions:
              file_storage:
                directory: /otel-logs-storage
                timeout: 10s
                create_directory: true

            exporters:
              # Forward traces to central gateway for distributed processing with load balancing
              loadbalancing/gateway:
                resolver:
                  dns:
                    hostname: gateway-collector-headless.opentelemetry-operator-system.svc.cluster.local
                    port: "4317"
                protocol:
                  otlp:
                    tls:
                      insecure: true
                    sending_queue:
                      enabled: true
                      num_consumers: 4
                      queue_size: 100
                    retry_on_failure:
                      enabled: true
                      initial_interval: 10ms
                      max_interval: 1m
                      max_elapsed_time: 10m
                  
              otlp/to:
                endpoint: tinyolly-otlp-receiver.tinyolly.svc.cluster.local:4343
                tls:
                  insecure: true
                sending_queue:
                  enabled: true
                  num_consumers: 4
                  queue_size: 100
                retry_on_failure:
                  enabled: true
                  initial_interval: 10ms
                  max_interval: 1m
                  max_elapsed_time: 10m

            service:
              extensions: [file_storage]
              pipelines:
                traces:
                  receivers: [otlp]
                  processors: [k8sattributes, resource, batch]
                  exporters: [loadbalancing/gateway]
                metrics:
                  receivers: [otlp]
                  processors: [k8sattributes, resource, batch]
                  exporters: [loadbalancing/gateway]
                logs:
                  receivers: [filelog, otlp]
                  processors: [k8sattributes, resource, batch]
                  exporters: [loadbalancing/gateway]

      # Central Gateway Collector for distributed trace processing
      - apiVersion: opentelemetry.io/v1alpha1
        kind: OpenTelemetryCollector
        metadata:
          name: gateway
          namespace: opentelemetry-operator-system
        spec:
          mode: deployment
          serviceAccount: gateway
          replicas: 1  # HA deployment
          config: |
            receivers:
              otlp:
                protocols:
                  grpc:
                    endpoint: 0.0.0.0:4317
                  http:
                    endpoint: 0.0.0.0:4318

            processors:
              batch:
                timeout: 1s
                send_batch_size: 1024
                
              # Tail sampling to collect complete traces before processing
              tail_sampling:
                decision_wait: 10s
                num_traces: 50000
                expected_new_traces_per_sec: 10
                policies:
                  # Sample all traces for now, but collect them completely first
                  - name: sample_all
                    type: always_sample
                
              # Transform processor to ensure proper service naming for trace correlation
              transform/service_names:
                error_mode: ignore
                trace_statements:
                  - context: span
                    statements:
                      # Extract service name from HTTPRoute upstream clusters for better trace correlation
                      - set(resource.attributes["service.name"], Split(attributes["upstream_cluster"], "/")[2]) where resource.attributes["service.name"] == "cluster-gateway.envoy-gateway-system" and attributes["upstream_cluster"] != nil and IsMatch(attributes["upstream_cluster"], "^httproute/[^/]+/[^/]+/rule/\\d+$")
              
              # Add Kubernetes attributes for any direct OTLP telemetry 
              k8sattributes:
                auth_type: "serviceAccount"
                passthrough: false
                extract:
                  metadata:
                    - k8s.pod.name
                    - k8s.pod.uid
                    - k8s.deployment.name
                    - k8s.namespace.name
                    - k8s.node.name
                    - k8s.pod.start_time
                  labels:
                    - tag_name: service.name
                      key: app.kubernetes.io/name
                      from: pod
                    - tag_name: service.version
                      key: app.kubernetes.io/version
                      from: pod
                    - tag_name: service.component
                      key: app.kubernetes.io/component
                      from: pod
                    - tag_name: service.instance.id
                      key: app.kubernetes.io/instance
                      from: pod
                    # Legacy label mappings
                    - tag_name: legacy.app
                      key: app
                      from: pod
                    - tag_name: legacy.version
                      key: version
                      from: pod
                  annotations:
                    - tag_name: deployment_config
                      key: deployment.kubernetes.io/config-hash
                      from: pod
                pod_association:
                  - sources:
                      - from: resource_attribute
                        name: k8s.pod.uid
                  - sources:
                      - from: resource_attribute
                        name: k8s.pod.name
                      - from: resource_attribute
                        name: k8s.namespace.name

            connectors:
              # Generate RED metrics from corrected traces
              spanmetrics:
                histogram:
                  explicit:
                    buckets: [1ms, 4ms, 10ms, 20ms, 50ms, 100ms, 200ms, 500ms, 1s, 2s, 5s]
                dimensions:
                  - name: http.method
                  - name: http.status_code
                dimensions_cache_size: 1000
                aggregation_temporality: "AGGREGATION_TEMPORALITY_CUMULATIVE"
                metrics_flush_interval: 15s
                metrics_expiration: 5m

            exporters:
              otlp/to:
                endpoint: tinyolly-otlp-receiver.tinyolly.svc.cluster.local:4343
                tls:
                  insecure: true
                sending_queue:
                  enabled: true
                  num_consumers: 4
                  queue_size: 100
                retry_on_failure:
                  enabled: true
                  initial_interval: 10ms
                  max_interval: 1m
                  max_elapsed_time: 10m

            service:
              pipelines:
                traces:
                  receivers: [otlp]
                  processors: [k8sattributes, tail_sampling, transform/service_names, batch]
                  exporters: [spanmetrics, otlp/to]
                metrics:
                  receivers: [spanmetrics, otlp]
                  processors: [k8sattributes, batch]
                  exporters: [otlp/to]
                logs:
                  receivers: [otlp]
                  processors: [k8sattributes, batch]
                  exporters: [otlp/to]

      - apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: agent
          namespace: opentelemetry-operator-system

      - apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: gateway
          namespace: opentelemetry-operator-system

      - apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRole
        metadata:
          name: agent
        rules:
        - apiGroups: [""]
          resources: ["pods", "namespaces"]
          verbs: ["get", "watch", "list"]
        - apiGroups: ["apps"]
          resources: ["replicasets"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["extensions"]
          resources: ["replicasets"]
          verbs: ["get", "list", "watch"]

      - apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRole
        metadata:
          name: gateway
        rules:
        - apiGroups: [""]
          resources: ["pods", "namespaces", "services", "endpoints"]
          verbs: ["get", "watch", "list"]
        - apiGroups: ["apps"]
          resources: ["replicasets"]
          verbs: ["get", "list", "watch"]

      - apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: agent
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: agent
        subjects:
        - kind: ServiceAccount
          name: agent
          namespace: opentelemetry-operator-system

      - apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: gateway
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: gateway
        subjects:
        - kind: ServiceAccount
          name: gateway
          namespace: opentelemetry-operator-system

      # OpenTelemetry Instrumentation CR for Python applications (opt-in)
      - apiVersion: opentelemetry.io/v1alpha1
        kind: Instrumentation
        metadata:
          name: python-instrumentation
          namespace: opentelemetry-operator-system
        spec:
          # Collector endpoint where telemetry will be exported
          exporter:
            endpoint: http://agent-collector.opentelemetry-operator-system.svc.cluster.local:4318
          # Propagators configuration
          propagators:
            - tracecontext
            - baggage
          # Resource attributes applied to all telemetry
          resource:
            attributes:
              deployment.environment: "development"
          # Python auto-instrumentation configuration
          python:
            # image: ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-python:0.44b0
            env:
              # Python-specific instrumentation settings (no spec equivalent)
              - name: OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED
                value: "true"
              - name: OTEL_PYTHON_LOG_CORRELATION
                value: "true"                
              - name: OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_SERVER_REQUEST
                value: "content-.*,x-.*"
              - name: OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_SERVER_RESPONSE  
                value: "content-.*,x-.*"
          # # Resource attributes that will be applied to all telemetry
          # resource:
          #   attributes:
          #     deployment.environment: "development"
          #     service.namespace: "default"