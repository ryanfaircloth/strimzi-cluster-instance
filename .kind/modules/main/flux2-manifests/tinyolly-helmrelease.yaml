apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tinyolly
  namespace: tinyolly
spec:
  interval: 15m
  dependsOn:
    - name: cert-manager
      namespace: cert-manager
    - name: gateway
      namespace: envoy-gateway-system
  chart:
    spec:
      chart: raw
      version: "2.0.2"
      sourceRef:
        kind: HelmRepository
        name: bedag
        namespace: flux-system
  values:
    resources:
      - apiVersion: v1
        kind: ConfigMap
        metadata:
          name: otel-collector-config
          namespace: tinyolly
        data:
          otel-collector-config.yaml: |
            # Default TinyOlly OTel Collector Config
            # This is the default configuration template used when no agents are connected.
            # It includes OTLP receivers, OpAMP extension, batch processing, spanmetrics
            # connector, and exports to both debug and OTLP endpoints.

            receivers:
              otlp/plain:
                protocols:
                  grpc:
                    endpoint: 0.0.0.0:4317
                  http:
                    endpoint: 0.0.0.0:4318
            extensions:
              opamp:
                server:
                  ws:
                    endpoint: ws://tinyolly-opamp-server:4320/v1/opamp

            processors:
              batch:
                timeout: 1s
                send_batch_size: 1024

            connectors:
              spanmetrics:
                histogram:
                  explicit:
                    buckets: [1ms, 4ms, 10ms, 20ms, 50ms, 100ms, 200ms, 500ms, 1s, 2s, 5s]
                dimensions:
                  - name: http.method
                  - name: http.status_code
                dimensions_cache_size: 1000
                aggregation_temporality: "AGGREGATION_TEMPORALITY_CUMULATIVE"
                metrics_flush_interval: 15s
                metrics_expiration: 5m

            exporters:
              debug:
                verbosity: detailed
              
              otlp:
                endpoint: "tinyolly-otlp-receiver:4343"
                tls:
                  insecure: true

            service:
              extensions: [opamp]
              pipelines:
                traces:
                  receivers: [otlp/plain]
                  processors: [batch]
                  exporters: [debug, otlp, spanmetrics]
                
                metrics:
                  receivers: [otlp/plain, spanmetrics]
                  processors: [batch]
                  exporters: [debug, otlp]
                
                logs:
                  receivers: [otlp/plain]
                  processors: [batch]
                  exporters: [debug, otlp]

      - apiVersion: v1
        kind: ConfigMap
        metadata:
          name: otel-supervisor-config
          namespace: tinyolly
        data:
          supervisor.yaml: |
            # OpAMP Supervisor Configuration for TinyOlly
            # This supervisor manages the OpenTelemetry Collector and accepts remote configuration
            # from the TinyOlly OpAMP server.

            server:
              endpoint: ws://tinyolly-opamp-server:4320/v1/opamp

            capabilities:
              # Accept remote configuration from OpAMP server
              accepts_remote_config: true
              # Accept restart commands
              accepts_restart_command: true
              # Report the effective (running) configuration back to server
              reports_effective_config: true
              # Report health status
              reports_health: true

            storage:
              # Directory for supervisor to store cached data
              directory: /var/lib/otelcol/supervisor

            agent:
              # Path to the collector binary
              executable: /opt/otelcol/bin/otelcol-contrib

              # How often to check if the collector process is still running
              orphan_detection_interval: 5s

              # Timeout for collector startup
              bootstrap_timeout: 10s

              # Configuration files to use
              # When $REMOTE_CONFIG is provided via OpAMP, it completely replaces the base config
              # (the supervisor handles this as a full replacement, not a merge)
              # The base config is only used until a remote config is first received
              config_files:
                - /etc/otelcol/config.yaml
                - $REMOTE_CONFIG

              # Allow the collector to start without any pipelines initially
              # (useful when waiting for remote config)
              args:
                - "--feature-gates"
                - "service.AllowNoPipelines"

      - apiVersion: v1
        kind: ConfigMap
        metadata:
          name: otelcol-templates
          namespace: tinyolly
        data:
          prometheus-remote-write.yaml: |
            # Prometheus Remote Write Template
            receivers:
              otlp:otlp:
                protocols:
                  grpc:
                    endpoint: 0.0.0.0:4317
                  http:
                    endpoint: 0.0.0.0:4318
            
            exporters:
              prometheus:
                endpoint: "0.0.0.0:19291"
            
            service:
              pipelines:
                metrics:
                  receivers: [otlp]
                  exporters: [prometheus]

      # 2. Redis deployment
      - apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: tinyolly-redis
          namespace: tinyolly
          labels:
            app: tinyolly-redis
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: tinyolly-redis
          template:
            metadata:
              labels:
                app: tinyolly-redis
            spec:
              containers:
              - name: redis
                image: redis:7-alpine
                command: 
                - redis-server
                - --port
                - "6579"
                - --maxmemory
                - "256mb"
                - --maxmemory-policy
                - "allkeys-lru"
                ports:
                - containerPort: 6579
                resources:
                  requests:
                    memory: "128Mi"
                    cpu: "100m"
                  limits:
                    memory: "256Mi"
                    cpu: "500m"
                livenessProbe:
                  exec:
                    command:
                    - redis-cli
                    - -p
                    - "6579"
                    - ping
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
                readinessProbe:
                  exec:
                    command:
                    - redis-cli
                    - -p
                    - "6579"
                    - ping
                  initialDelaySeconds: 5
                  periodSeconds: 5
                  timeoutSeconds: 3
                  failureThreshold: 3

      - apiVersion: v1
        kind: Service
        metadata:
          name: tinyolly-redis
          namespace: tinyolly
        spec:
          selector:
            app: tinyolly-redis
          ports:
            - protocol: TCP
              port: 6579
              targetPort: 6579

      # 3. TinyOlly OTLP Receiver
      - apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: tinyolly-otlp-receiver
          namespace: tinyolly
          labels:
            app: tinyolly-otlp-receiver
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: tinyolly-otlp-receiver
          template:
            metadata:
              labels:
                app: tinyolly-otlp-receiver
            spec:
              containers:
              - name: tinyolly-otlp-receiver
                image: tinyolly/otlp-receiver:latest
                imagePullPolicy: Always
                ports:
                - containerPort: 4343
                env:
                - name: REDIS_HOST
                  value: "tinyolly-redis"
                - name: REDIS_PORT
                  value: "6579"
                - name: PORT
                  value: "4343"
                # Disable OpenTelemetry auto-instrumentation for OTLP receiver
                - name: OTEL_SDK_DISABLED
                  value: "true"
                - name: OTEL_PYTHON_DISABLED
                  value: "true"
                - name: OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED
                  value: "false"
                # - name: OTEL_SERVICE_NAME
                #   value: "tinyolly-otlp-receiver"
                # - name: OTEL_EXPORTER_OTLP_ENDPOINT
                #   value: "http://agent-collector.opentelemetry-operator-system.svc.cluster.local:4318"
                # - name: OTEL_EXPORTER_OTLP_PROTOCOL
                #   value: "http/protobuf"
                # - name: OTEL_EXPORTER_OTLP_LOGS_ENDPOINT
                #   value: "http://agent-collector.opentelemetry-operator-system.svc.cluster.local:4318/v1/logs"
                # - name: OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED
                #   value: "true"
                resources:
                  requests:
                    memory: "128Mi"
                    cpu: "100m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
                livenessProbe:
                  tcpSocket:
                    port: 4343
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
                readinessProbe:
                  tcpSocket:
                    port: 4343
                  initialDelaySeconds: 10
                  periodSeconds: 5
                  timeoutSeconds: 3
                  failureThreshold: 3

      - apiVersion: v1
        kind: Service
        metadata:
          name: tinyolly-otlp-receiver
          namespace: tinyolly
        spec:
          selector:
            app: tinyolly-otlp-receiver
          ports:
            - protocol: TCP
              port: 4343
              targetPort: 4343
              name: grpc

      # # 4. TinyOlly OpAMP Server
      # - apiVersion: apps/v1
      #   kind: Deployment
      #   metadata:
      #     name: tinyolly-opamp-server
      #     namespace: tinyolly
      #     labels:
      #       app: tinyolly-opamp-server
      #   spec:
      #     replicas: 1
      #     selector:
      #       matchLabels:
      #         app: tinyolly-opamp-server
      #     template:
      #       metadata:
      #         labels:
      #           app: tinyolly-opamp-server
      #       spec:
      #         containers:
      #         - name: tinyolly-opamp-server
      #           image: tinyolly/opamp-server:latest
      #           imagePullPolicy: Always
      #           ports:
      #           - containerPort: 4320
      #             name: websocket
      #           - containerPort: 4321
      #             name: http
      #           env:
      #           - name: OPAMP_PORT
      #             value: "4320"
      #           - name: HTTP_PORT
      #             value: "4321"
      #           - name: COLLECTOR_CONFIG_PATH
      #             value: "/etc/otel-collector-config.yaml"
      #           # - name: OTEL_SERVICE_NAME
      #           #   value: "tinyolly-opamp-server"
      #           # - name: OTEL_EXPORTER_OTLP_ENDPOINT
      #           #   value: "http://agent-collector.opentelemetry-operator-system.svc.cluster.local:4318"
      #           # - name: OTEL_EXPORTER_OTLP_PROTOCOL
      #           #   value: "http/protobuf"
      #           # - name: OTEL_EXPORTER_OTLP_LOGS_ENDPOINT
      #           #   value: "http://agent-collector.opentelemetry-operator-system.svc.cluster.local:4318/v1/logs"
      #           volumeMounts:
      #           - name: otel-collector-config-vol
      #             mountPath: /etc/otel-collector-config.yaml
      #             subPath: otel-collector-config.yaml
      #           resources:
      #             requests:
      #               memory: "64Mi"
      #               cpu: "50m"
      #             limits:
      #               memory: "256Mi"
      #               cpu: "200m"
      #           livenessProbe:
      #             httpGet:
      #               path: /health
      #               port: 4321
      #             initialDelaySeconds: 30
      #             periodSeconds: 10
      #             timeoutSeconds: 5
      #             failureThreshold: 3
      #           readinessProbe:
      #             httpGet:
      #               path: /health
      #               port: 4321
      #             initialDelaySeconds: 10
      #             periodSeconds: 5
      #             timeoutSeconds: 3
      #             failureThreshold: 3
      #         volumes:
      #         - name: otel-collector-config-vol
      #           configMap:
      #             name: otel-collector-config

      # - apiVersion: v1
      #   kind: Service
      #   metadata:
      #     name: tinyolly-opamp-server
      #     namespace: tinyolly
      #   spec:
      #     selector:
      #       app: tinyolly-opamp-server
      #     ports:
      #       - name: websocket
      #         protocol: TCP
      #         port: 4320
      #         targetPort: 4320
      #       - name: http
      #         protocol: TCP
      #         port: 4321
      #         targetPort: 4321

      # # 5. OTel Collector
      # - apiVersion: apps/v1
      #   kind: Deployment
      #   metadata:
      #     name: otel-collector
      #     namespace: tinyolly
      #     labels:
      #       app: otel-collector
      #   spec:
      #     replicas: 1
      #     selector:
      #       matchLabels:
      #         app: otel-collector
      #     template:
      #       metadata:
      #         labels:
      #           app: otel-collector
      #       spec:
      #         terminationGracePeriodSeconds: 30
      #         containers:
      #         - name: otel-collector
      #           image: tinyolly/otel-supervisor:latest
      #           imagePullPolicy: Always
      #           ports:
      #           - containerPort: 4317
      #             name: otlp-grpc-notls
      #           - containerPort: 4318
      #             name: otlp-http-notls
      #           - containerPort: 4417
      #             name: otlp-grpc-tls
      #           - containerPort: 4418
      #             name: otlp-http-tls
      #           - containerPort: 19291
      #             name: prom-rw
      #           resources:
      #             requests:
      #               memory: "128Mi"
      #               cpu: "100m"
      #             limits:
      #               memory: "512Mi"
      #               cpu: "500m"
      #           volumeMounts:
      #           - name: supervisor-config-vol
      #             mountPath: /etc/otelcol/supervisor.yaml
      #             subPath: supervisor.yaml
      #           - name: otel-collector-config-vol
      #             mountPath: /etc/otelcol/config.yaml
      #             subPath: otel-collector-config.yaml
      #           - name: supervisor-data
      #             mountPath: /var/lib/otelcol/supervisor
      #           - name: otel-collector-cert-vol
      #             mountPath: /certs
      #             readOnly: true
      #         volumes:
      #         - name: supervisor-config-vol
      #           configMap:
      #             name: otel-supervisor-config
      #         - name: otel-collector-config-vol
      #           configMap:
      #             name: otel-collector-config
      #         - name: supervisor-data
      #           emptyDir: {}
      #         - name: otel-collector-cert-vol
      #           secret:
      #             secretName: otel-collector-cert

      # - apiVersion: v1
      #   kind: Service
      #   metadata:
      #     name: otel-collector
      #     namespace: tinyolly
      #   spec:
      #     selector:
      #       app: otel-collector
      #     ports:
      #       - name: grpc-notls
      #         protocol: TCP
      #         port: 4317
      #         targetPort: 4317
      #       - name: http-notls
      #         protocol: TCP
      #         port: 4318
      #         targetPort: 4318
      #       - name: grpc-tls
      #         protocol: TCP
      #         port: 4417
      #         targetPort: 4417
      #       - name: http-tls
      #         protocol: TCP
      #         port: 4418
      #         targetPort: 4418
      #       - name: prom-rw
      #         protocol: TCP
      #         port: 19291
      #         targetPort: 19291

      # 6. TinyOlly UI
      - apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: tinyolly-ui
          namespace: tinyolly
          labels:
            app: tinyolly-ui
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: tinyolly-ui
          template:
            metadata:
              labels:
                app: tinyolly-ui
            spec:
              containers:
              - name: tinyolly-ui
                image: tinyolly/ui:latest
                imagePullPolicy: Always
                ports:
                - containerPort: 5002
                env:
                - name: REDIS_HOST
                  value: "tinyolly-redis"
                - name: REDIS_PORT
                  value: "6579"
                - name: DEPLOYMENT_ENV
                  value: "kubernetes"
                # Disable OpenTelemetry auto-instrumentation for TinyOlly UI
                - name: OTEL_SDK_DISABLED
                  value: "true"
                - name: OTEL_PYTHON_DISABLED
                  value: "true" 
                - name: OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED
                  value: "false"
                # - name: OTEL_SERVICE_NAME
                #   value: "tinyolly-ui"
                # - name: OTEL_EXPORTER_OTLP_ENDPOINT
                #   value: "http://agent-collector.opentelemetry-operator-system.svc.cluster.local:4318"
                # - name: OTEL_EXPORTER_OTLP_PROTOCOL
                #   value: "http/protobuf"
                # - name: OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
                #   value: "http://agent-collector.opentelemetry-operator-system.svc.cluster.local:4318/v1/traces"
                # - name: OTEL_EXPORTER_OTLP_METRICS_ENDPOINT
                #   value: "http://agent-collector.opentelemetry-operator-system.svc.cluster.local:4318/v1/metrics"
                # - name: OTEL_EXPORTER_OTLP_LOGS_ENDPOINT
                #   value: "http://agent-collector.opentelemetry-operator-system.svc.cluster.local:4318/v1/logs"
                # - name: OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED
                #   value: "true"
                # - name: OPAMP_SERVER_URL
                #   value: "http://tinyolly-opamp-server:4321"
                # - name: OTELCOL_DEFAULT_CONFIG
                #   value: "/app/otelcol-config.yaml"
                volumeMounts:
                - name: otelcol-config-vol
                  mountPath: /app/otelcol-config.yaml
                  subPath: otel-collector-config.yaml
                - name: otelcol-templates-vol
                  mountPath: /app/otelcol-templates
                resources:
                  requests:
                    memory: "128Mi"
                    cpu: "100m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
                livenessProbe:
                  httpGet:
                    path: /health
                    port: 5002
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
                readinessProbe:
                  httpGet:
                    path: /health
                    port: 5002
                  initialDelaySeconds: 10
                  periodSeconds: 5
                  timeoutSeconds: 3
                  failureThreshold: 3
              volumes:
              - name: otelcol-config-vol
                configMap:
                  name: otel-collector-config
              - name: otelcol-templates-vol
                configMap:
                  name: otelcol-templates

      - apiVersion: v1
        kind: Service
        metadata:
          name: tinyolly-ui
          namespace: tinyolly
        spec:
          type: ClusterIP
          selector:
            app: tinyolly-ui
          ports:
            - protocol: TCP
              port: 5002
              targetPort: 5002

      - apiVersion: gateway.networking.k8s.io/v1
        kind: HTTPRoute
        metadata:
          name: tinyolly-ui-route
          namespace: tinyolly
          annotations:
            # Annotation to help identify the backend service for tracing
            gateway.envoyproxy.io/backend-service: "tinyolly-ui"
            # OpenTelemetry service name override
            opentelemetry.io/service-name: "tinyolly-ui"
        spec:
          parentRefs:
          - name: management-gateway
            namespace: envoy-gateway-system
            sectionName: mgmt-https-listener
          hostnames:
          - "to.strimzi.gateway.api.test"
          rules:
          - matches:
            - path:
                type: PathPrefix
                value: /
            backendRefs:
            - name: tinyolly-ui
              port: 5002